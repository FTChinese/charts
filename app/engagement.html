<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Engagement</title>
  <meta name="google-signin-client_id" content="911260228291-d2b7cjs7c0ajobjd6l89133tv4bmrcjb.apps.googleusercontent.com">
  <meta name="google-signin-scope" content="https://www.googleapis.com/auth/analytics.readonly">
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" href="http://static.ftchinese.com/img/ipad_icon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>



<p align=right>
  <!-- The Sign-in button. This will run `queryReports()` on success. -->
  <div class="g-signin2" data-onsuccess="queryDifferentReports"></div>
</p>

<div class="page-container" id="charts-container">
  <h1 class="page-title">Engagement</h1>
</div>


<!--
<script src="../bower_components/highcharts/highcharts.js"></script>
<script src="../bower_components/highcharts/modules/funnel.js"></script>


<script src="../bower_components/highcharts/highcharts-more.js"></script>
<script src="../bower_components/highmaps-beta/modules/map.js"></script>
<script src="../bower_components/highmaps-beta/modules/data.js"></script>
-->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/funnel.js"></script>
<script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
<script type="text/javascript" src="scripts/highcharts.js"></script>
<script type="text/javascript" src="scripts/main.js"></script>



<script>
// MARK: - These are different in every page. 

// Replace with your view ID.
const VIEW_ID_All = '10995661'; 
const VIEW_ID_iPhoneApp = '108134561'; //
//var startDate = '2017-04-27';
// var endDate = '2017-05-16';

const  startDate = '90daysago';
const endDate = 'today';

const requestData0 = [
  {
    'viewId': VIEW_ID_All,
    'dateRanges': [
      {
        'startDate': startDate,
        'endDate': endDate
      }
    ],
    'metrics': [
      {
        'expression': 'ga:users'
      }
    ]
  }
];
const requestData1 = [
  {
    'viewId': VIEW_ID_iPhoneApp,
    'dateRanges': [
      {
        'startDate': startDate,
        'endDate': endDate
      }
    ],
    'metrics': [
      {
        'expression': 'ga:users'
      }
    ]
  },
  {
    'viewId': VIEW_ID_iPhoneApp,
    'dateRanges': [
    {
        'startDate': startDate,
        'endDate': endDate
    }
    ],
    'metrics': [
    {
        'expression': 'ga:totalEvents'
    }
    ],
    'dimensionFilterClauses': [
        {
            'operator': 'AND',
            'filters': [
            {
                'dimensionName': 'ga:eventCategory',
                'operator': 'EXACT',
                'expressions': [
                'Privileges'
                ],
                'caseSensitive': true
            },
            {
                'dimensionName': 'ga:eventAction',
                'operator': 'BEGINS_WITH',
                'expressions': [
                'buy success: '//为什么这里和统计EXACT buy success: com.ft.ftchinese.mobile.subscription.member加上buy success: com.ft.ftchinese.mobile.subscription.vip不一样
                ],
                'caseSensitive': true
            }
            ]
        }
    ]
  },
  {
    'viewId': VIEW_ID_iPhoneApp,
    'dateRanges': [
    {
        'startDate': startDate,
        'endDate': endDate
    }
    ],
    'metrics': [
    {
        'expression': 'ga:totalEvents'
    }
    ],
    'dimensionFilterClauses': [
        {
            'operator': 'AND',
            'filters': [
                {
                    'dimensionName': 'ga:eventCategory',
                    'operator': 'EXACT',
                    'expressions': [
                    'Privileges'
                    ],
                    'caseSensitive': true
                },
                {
                    'dimensionName': 'ga:eventAction',
                    'operator': 'EXACT',
                    'expressions': [
                    'buy success: com.ft.ftchinese.mobile.subscription.vip'
                    ],
                    'caseSensitive': true
                }
            ]
        }
    ]
  }
];
//QUEST:金字塔关注的是buy success，而用户行为相关性分析关注buy ？
const requestData2 = [
    {
        'viewId': VIEW_ID_iPhoneApp,
        'dateRanges': [
        {
            'startDate': startDate,
            'endDate': endDate
        }
        ],
        'metrics': [
            {
                'expression': 'ga:totalEvents'
            }
        ],
        'dimensions': [
            {
                'name': 'ga:date'
            }
        ],
        'dimensionFilterClauses': [
            {
                'operator': 'AND',
                'filters': [
                    {
                        'dimensionName': 'ga:eventCategory',
                        'operator': 'EXACT',
                        'expressions': [
                        'Privileges'
                        ],
                        'caseSensitive': true
                    },
                    {
                        'dimensionName': 'ga:eventAction',
                        'operator': 'EXACT',
                        'expressions': [
                        'Display'
                        ],
                        'caseSensitive': true
                    }
                ]
            }
        ]
    },
    {
        'viewId': VIEW_ID_iPhoneApp,
        'dateRanges': [
        {
            'startDate': startDate,
            'endDate': endDate
        }
        ],
        'metrics': [
            {
                'expression': 'ga:totalEvents'
            }
        ],
        'dimensions': [
            {
                'name': 'ga:date'
            }
        ],
        'dimensionFilterClauses': [
            {
                'operator': 'AND',
                'filters': [
                    {
                        'dimensionName': 'ga:eventCategory',
                        'operator': 'EXACT',
                        'expressions': [
                        'Privileges'
                        ],
                        'caseSensitive': true
                    },
                    {
                        'dimensionName': 'ga:eventAction',
                        'operator': 'EXACT',
                        'expressions': [
                            'Tap Subscription'
                        ],
                        'caseSensitive': true
                    }
                ]
            }
        ]
    },
    {
      'viewId': VIEW_ID_iPhoneApp,
      'dateRanges': [
        {
          'startDate': startDate,
          'endDate': endDate
        }
      ],
      'metrics': [
        {
          'expression': 'ga:totalEvents'
        }
      ],
      'dimensions': [
        {
          'name': 'ga:date'
        }
      ],
      'dimensionFilterClauses': [
        {
          'operator': 'AND',
          'filters': [
            {
              'dimensionName': 'ga:eventCategory',
              'operator': 'EXACT',
              'expressions': [
                'Privileges'
              ],
              'caseSensitive': true
            },
            {
              'dimensionName': 'ga:eventAction',
              'operator': 'EXACT',
              'expressions': [
                'buy: com.ft.ftchinese.mobile.subscription.member'
              ],
              'caseSensitive': true
            }
          ]
        }
      ]
    },
    {
      'viewId': VIEW_ID_iPhoneApp,
      'dateRanges': [
        {
          'startDate': startDate,
          'endDate': endDate
        }
      ],
      'metrics': [
        {
          'expression': 'ga:totalEvents'
        }
      ],
      'dimensions': [
        {
          'name': 'ga:date'
        }
      ],
      'dimensionFilterClauses': [
        {
          'operator': 'AND',
          'filters': [
            {
              'dimensionName': 'ga:eventCategory',
              'operator': 'EXACT',
              'expressions': [
                'Privileges'
              ],
              'caseSensitive': true
            },
            {
              'dimensionName': 'ga:eventAction',
              'operator': 'EXACT',
              'expressions': [
                'buy: com.ft.ftchinese.mobile.subscription.vip'
              ],
              'caseSensitive': true
            }
          ]
        }
      ]
    }
]

const requestDataArr = [requestData0, requestData1];
const responseDataArr = [];



async function drawCharts(responseDataArr) {
  console.log(responseDataArr);
  var chartId;
  const resultData0 = responseDataArr[0].reports[0].data.rows[0].metrics[0].values[0];
  console.log(`resultData0:${resultData0}`);
  const resultData1 = responseDataArr[1].reports[0].data.rows[0].metrics[0].values[0];
  const resultData2 = responseDataArr[1].reports[1].data.rows[0].metrics[0].values[0];//购买成功的总数
  const resultData3 = responseDataArr[1].reports[2].data.rows[0].metrics[0].values[0];
  console.log(`resultData1:${resultData1}`);

  // MARK:金字塔图
  const allUsers = Number(resultData0);
  const opportunityTotalUsers = Number(resultData1-resultData2);
  const standardUsers = Number(resultData2-resultData3);  
  const premiumUsers = Number(resultData3);
  
  const restUsers = allUsers-opportunityTotalUsers;
  const opportunityUsers = opportunityTotalUsers - standardUsers - premiumUsers;

  
  chartId = createChart();
  const  pyramid = new Highcharts.Chart({
      chart: {
          type: 'pyramid',
          renderTo: chartId
      },
      title: {
          text: 'Engagement pyramid'
      },
      plotOptions: {
        series: {
            dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b> ({point.y:,.0f})',
                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                softConnector: true
            },
            center: ['40%', '50%'],
            width: '80%'
        }
    },
    legend: {
        enabled: false
    },
    series: [{
      name: 'Unique users',
      data: [
        ['Rest Users', restUsers], //9074799
        ['Opportunity Users',  opportunityUsers], //247243
        ['Standard Users', standardUsers],
        ['Premium Users',  premiumUsers]
      ]
    }]
  });


 

  const engagementData = await getStoredDataFile('../data/engagementData.json');
  console.log(engagementData);
  console.log(JSON.stringify(engagementData));
  const SDataSet = [];
  const FDataSet = [];
  const VDataSet = [];
  const RDataSet = [];
  for(const oneDataItem of engagementData){
    const S = oneDataItem.S;
    const F = oneDataItem.F;
    const V = oneDataItem.V;
    const R = oneDataItem.R;
    SDataSet.push(S);
    FDataSet.push(F);
    VDataSet.push(V);
    RDataSet.push(R);
  }
  //S的分布图
  console.log(SDataSet);
  chartId = createChart();
  Highcharts.chart(chartId, {
    title: {
        text: 'Bell curve'
    },

    xAxis: [{
        title: {
            text: 'Data'
        },
        alignTicks: false
    }, {
        title: {
            text: 'Bell curve'
        },
        alignTicks: false,
        opposite: true
    }],

    yAxis: [{
        title: { text: 'Data' }
    }, {
        title: { text: 'Bell curve' },
        opposite: true
    }],

    series: [{
        name: 'Bell curve',
        type: 'bellcurve',
        xAxis: 1,
        yAxis: 1,
        baseSeries: 1,
        zIndex: -1
    }, {
        name: 'Data',
        type: 'scatter',
        data: SDataSet,
        marker: {
            radius: 1.5
        }
    }]
  });

  //F的分布图
  console.log(FDataSet);
  chartId = createChart();
  Highcharts.chart(chartId, {
    title: {
        text: 'Bell curve'
    },

    xAxis: [{
        title: {
            text: 'Data'
        },
        alignTicks: false
    }, {
        title: {
            text: 'Bell curve'
        },
        alignTicks: false,
        opposite: true
    }],

    yAxis: [{
        title: { text: 'Data' }
    }, {
        title: { text: 'Bell curve' },
        opposite: true
    }],

    series: [{
        name: 'Bell curve',
        type: 'bellcurve',
        xAxis: 1,
        yAxis: 1,
        baseSeries: 1,
        zIndex: -1
    }, {
        name: 'Data',
        type: 'scatter',
        data: FDataSet,
        marker: {
            radius: 1.5
        }
    }]
  });
}
// 分布图绘制Demo:http://jsfiddle.net/gh/get/library/pure/highcharts/highcharts/tree/master/samples/highcharts/demo/bellcurve/

</script>




<!-- Load the JavaScript API client and Sign-in library. -->
<script src="https://apis.google.com/js/client:platform.js"></script>

</body>
</html>