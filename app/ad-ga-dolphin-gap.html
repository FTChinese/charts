<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Subscription</title>
  <meta name="google-signin-client_id" content="911260228291-d2b7cjs7c0ajobjd6l89133tv4bmrcjb.apps.googleusercontent.com">
  <meta name="google-signin-scope" content="https://www.googleapis.com/auth/analytics.readonly">
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" href="http://static.ftchinese.com/img/ipad_icon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>


<p align=right>
  <!-- The Sign-in button. This will run `queryReports()` on success. -->
  <div class="g-signin2" data-onsuccess="queryReportsAll"></div>
</p>

<div class="page-container" id="charts-container">
  <h1 class="page-title">Subscription</h1>
</div>



<!-- build:remove -->
<script src="../bower_components/highcharts/highcharts.js"></script>
<script src="../bower_components/highcharts/highcharts-more.js"></script>
<script src="../bower_components/highmaps-beta/modules/map.js"></script>
<script src="../bower_components/highmaps-beta/modules/data.js"></script>
<script src="../bower_components/highcharts/modules/funnel.js"></script>
<script type="text/javascript" src="scripts/highcharts.js"></script>
<!-- endbuild -->
<script type="text/javascript" src="scripts/main.js"></script>
<script src="scripts/addFeatureToTable.js"></script>

<script>
// MARK: - These are different in every page. 
var product = gup('product', window.location.href);
var VIEW_ID;
var pageTitle;
var startDate;
var endDate = 'today';
VIEW_ID = '10995661';
startDate = '2018-06-05';
pageTitle = 'Ad Gap Report';

document.title = pageTitle;
document.querySelector('.page-title').innerHTML = pageTitle;

function constructQuerryData(startDate, endDate) {
  var adIdExp = window.adInfoFromDolphin.ids.join('|');
  var queryData = [
    { // record Request
      'viewId': VIEW_ID,
      'dateRanges': [
        {
          'startDate': startDate,
          'endDate': endDate
        }
      ],
      'metrics': [
        {
          'expression': 'ga:totalEvents'
        }
      ],
      'dimensions': [
        {
          'name': 'ga:eventCategory'
        },
        {
          'name': 'ga:date'
        }
      ],
      'dimensionFilterClauses': [
        {
          'operator': 'AND',
          'filters': [
            {
              'dimensionName': 'ga:eventCategory',
              'operator': 'REGEXP',
              'expressions': [
                //'\\(605326\\)$'
                adIdExp
              ],
              'caseSensitive': true
            },
            {
              'dimensionName': 'ga:eventAction',
              'operator': 'EXACT',
              'expressions': [
                'Request'
              ],
              'caseSensitive': true
            }
          ]
        }
      ]
    }
  ];
  return queryData;
}

function drawChartsAll() {

  var chartId;
  // MARK: - The base key which should have no gap in data
  // var keys = gaDataReports[0].data.rows.map(function(row){
  //   return row.dimensions[0];
  // });

  //console.log (gaDataReports);

  var gaRows = {};
  for (row of gaDataReports[0].data.rows) {
    const name = row.dimensions[0].replace(/\D/g,'');
    const date = row.dimensions[1];
    const value = row.metrics[0].values[0];
    if (gaRows[name] === undefined) {
      gaRows[name] = {};
    }
    gaRows[name][date] = value;
  }

  for (id of window.adInfoFromDolphin.ids) {
      var adInfo = window.adInfoFromDolphin.ads[id]
      var title = adInfo.name + '(' + adInfo.adid + ')';
      var dolphinDataSource = adInfo.requests;
      var keys = [];
      var data = [];
      var gaData = [];
      const gaRow = gaRows[id];      
      for (const key of Object.keys(dolphinDataSource)) {
        keys.unshift(key);
        const value = parseInt(dolphinDataSource[key], 10) || 0;
        data.unshift(value);
        if (gaRow) {
          const gaKey = key.replace(/\D/g, '');
          var gaValue = gaRow[gaKey] || 0;
          gaValue = parseInt(gaValue, 10) || 0;
          gaData.unshift(gaValue);
        }
      }
      if (gaData.length > 0) {
        chartId = createChart();
        var oneChart = new Highcharts.Chart({
          chart: {
              type: 'column',
              renderTo: chartId
          },
          title: {
              text: title
          },
          xAxis: {
              categories: keys,
              tickmarkPlacement: 'on',
              title: {
                  enabled: false
              }
          },
          yAxis: {
              title: {
                  text: ''
              }
          },
          tooltip: {
              pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y:.1f}%</b><br/>',
              shared: true
          },
          series: [
            {
              name: 'Dolphin',
              data: data
            },
            {
              name: 'Google Analytics',
              data: gaData
            }
          ],
          credits: {
            enabled: false
          },
          legend: {
            enabled: true
          }
        });
      }
  }





  // drawChartByKey({
  //   title: 'Failed Subscription Payment Attempts',
  //   type: 'column',
  //   percentage: false,
  //   keys: keys,
  //   data: [
  //     {
  //       index: 0,
  //       name: 'Standard'
  //     },
  //     {
  //       index: 1,
  //       name: 'Premium'
  //     }
  //   ]
  // });

  // drawTable({
  //   title: 'Users Who Failed to Pay with iOS IAP',
  //   description: 'These are the users that intended to pay but could not do so because of Apple\'s server problem. We should consider ways to get the revenue back. Possible channels: In App Texts, Push notifications, Emails, etc...',
  //   index: 2
  // });


  //addFeatureToTable();

}
</script>





<script>
  callAjax('ad-dolphin.csv', function(csvText) {
    try {
      window.adInfoFromDolphin = getAdInfoFromDolphineCSV(csvText);
    } catch (err) {
      console.log (err);
      return;
    }
    if (window.adInfoFromDolphin === undefined) {
      return;
    }
    var script = document.createElement('script');
    // MARK: - Load the JavaScript API client and Sign-in library. 
    script.src = 'https://apis.google.com/js/client:platform.js';
    document.head.appendChild(script);
  });
</script>

</body>
</html>